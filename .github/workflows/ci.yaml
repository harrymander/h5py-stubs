on:
  push:
    branches: ["*"]
  pull_request:
jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
      - name: Setup Python
        uses: actions/setup-python@v6
      - name: Run pre-commit hooks
        uses: pre-commit/action@v3.0.1
  type-checking:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: Setup uv
        uses: astral-sh/setup-uv@v6
        with:
          version: 0.8.14
      - name: Install locked dependencies
        run: uv sync
      - name: Install latest type-checker dependencies
        run: |
          uv pip install --upgrade \
            basedpyright \
            mypy \
            pyrefly \
            pyright \
            ty
      - name: Run mypy
        run: uv run mypy src
      - name: Run basedpyright
        run: uv run basedpyright src
      - name: Configure pyright
        # basedpyright supports a "recommended" type checking mode, which is
        # similar to pyright's "strict" mode. Modify the option in
        # pyrightconfig.json to ensure pyright runs in strict mode.
        run: |
          sed -i \
            's/"typeCheckingMode": "recommended"/"typeCheckingMode": "strict"/' \
            pyrightconfig.json
          # Check that the file was changed
          ! git diff --exit-code pyrightconfig.json
      - name: Run pyright
        run: uv run pyright src
      - name: Run pyrefly
        run: uv run pyrefly check src
      - name: Run ty
        run: uv run ty check src
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: Setup uv
        uses: astral-sh/setup-uv@v6
        with:
          version: 0.8.14
      - name: Install dependencies
        run: uv sync --group tests
      - name: Run tests
        run: COLUMNS=120 uv run pytest -vvv --color=yes
